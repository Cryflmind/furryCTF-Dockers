FROM python:3.9-slim

# 1. 安装基础环境 - 如果 sources.list 存在则换源
RUN if [ -f /etc/apt/sources.list ]; then \
        sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list && \
        sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list; \
    fi && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    nginx \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 2. 安装依赖
COPY requirements.txt .
RUN pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/

# 3. 复制源码
COPY src/ .

# 4. --- 伪造 Git 开发历史 ---
RUN git config --global user.email "devops@nexus-corp.internal" && \
    git config --global user.name "Nexus DevOps" && \
    git init && \
    \
    # [Commit 1] 早期开发版本 (包含硬编码 Key)
    echo 'import os' > config.py && \
    echo 'SECRET_KEY = "This_key_has_been_deprecated_v2023"' >> config.py && \
    echo 'SECRET_KEY_FALLBACKS = []' >> config.py && \
    git add . && \
    git commit -m "feat(auth): init authentication module with static config" && \
    \
    # [Commit 2] 安全合规升级 (触发 CVE 配置)
    echo 'import os' > config.py && \
    echo '# Auto-generated by KMS rotation service' >> config.py && \
    echo 'SECRET_KEY = os.urandom(32)' >> config.py && \
    echo 'SECRET_KEY_FALLBACKS = ["This_key_has_been_deprecated_v2023"]' >> config.py && \
    git add config.py && \
    git commit -m "fix(sec): compliant with ISO-27001 key rotation policy (JIRA-SEC-402)" && \
    \
    # [清理] 编译并删除 config.py 源码，增加黑盒难度
    # 选手必须翻 Git 历史或者反编译 config.pyc 才能看到 Key
    python -m compileall config.py && \
    mv __pycache__/config.*.pyc ./config.pyc && \
    rm config.py && rm -rf __pycache__

# 5. 配置 Nginx
COPY nginx.conf /etc/nginx/sites-available/default

# 6. 启动脚本
COPY start.sh .
RUN chmod +x start.sh

EXPOSE 80

CMD ["./start.sh"]
