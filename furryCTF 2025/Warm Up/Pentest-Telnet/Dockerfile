# 本题利用 CVE-2026-24061 在Docker内提权读取flag
FROM debian:12-slim

ENV DEBIAN_FRONTEND=noninteractive
ENV GZCTF_FLAG=""

# 先 HTTP 装 CA，再切 HTTPS（清华源）
RUN set -eux; \
  if [ -f /etc/apt/sources.list.d/debian.sources ]; then \
    sed -i 's|http://deb.debian.org/debian|http://mirrors.tuna.tsinghua.edu.cn/debian|g' /etc/apt/sources.list.d/debian.sources; \
    sed -i 's|http://security.debian.org/debian-security|http://mirrors.tuna.tsinghua.edu.cn/debian-security|g' /etc/apt/sources.list.d/debian.sources; \
  else \
    printf '%s\n' \
      'deb http://mirrors.tuna.tsinghua.edu.cn/debian bookworm main contrib non-free non-free-firmware' \
      'deb http://mirrors.tuna.tsinghua.edu.cn/debian bookworm-updates main contrib non-free non-free-firmware' \
      'deb http://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free non-free-firmware' \
      > /etc/apt/sources.list; \
  fi; \
  apt-get update; \
  apt-get install -y --no-install-recommends ca-certificates; \
  rm -rf /var/lib/apt/lists/*; \
  if [ -f /etc/apt/sources.list.d/debian.sources ]; then \
    sed -i 's|http://mirrors.tuna.tsinghua.edu.cn|https://mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources; \
  else \
    sed -i 's|http://mirrors.tuna.tsinghua.edu.cn|https://mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list; \
  fi

# 安装：GNU inetutils telnetd + inetd
RUN apt-get update && apt-get install -y --no-install-recommends \
    inetutils-telnetd \
    openbsd-inetd \
    login \
    passwd \
    pwgen \
    procps \
    telnet \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 创建低权限用户（选手初始登录账号）
# 你也可以把密码改成你想要的固定值，方便出题
RUN useradd -m -s /bin/bash ctf && \
    echo 'ctf:ctf123456' | chpasswd

# 生成 root 密码（用于自检；注意写入文件为“纯密码”避免登录复制粘贴失败）
RUN ROOT_PASSWORD="$(pwgen -s 32 1)" && \
    echo "root:${ROOT_PASSWORD}" | chpasswd && \
    printf "%s\n" "${ROOT_PASSWORD}" > /root_password && \
    chmod 600 /root_password

# 写 flag（权限改为 root-only，确保低权限用户无法读取）
RUN printf '%s\n' '#!/bin/sh' > /write_flag.sh && \
    printf '%s\n' 'if [ -n "$GZCTF_FLAG" ]; then echo "$GZCTF_FLAG" > /flag.txt; else echo "GZCTF_FLAG" > /flag.txt; fi' >> /write_flag.sh && \
    printf '%s\n' 'chown root:root /flag.txt' >> /write_flag.sh && \
    printf '%s\n' 'chmod 400 /flag.txt' >> /write_flag.sh && \
    printf '%s\n' 'unset GZCTF_FLAG || true' >> /write_flag.sh && \
    chmod +x /write_flag.sh

# inetd 配置：监听 23，连接来时启动 telnetd（端口写死 + 正确二进制路径）
RUN printf '%s\n' \
 '23  stream  tcp  nowait  root  /usr/bin/env  env -i PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin TERM=linux /usr/sbin/telnetd' \
 > /etc/inetd.conf


# 启动脚本：openbsd-inetd 不支持 -f；配置文件用位置参数
# 将 set -eu 改为 set -e，避免 -u 导致 “parameter not set” 干扰
RUN printf '%s\n' '#!/bin/sh' > /start.sh && \
    printf '%s\n' 'set -e' >> /start.sh && \
    printf '%s\n' '/write_flag.sh' >> /start.sh && \
    printf '%s\n' 'echo "[*] inetutils-telnetd version: $(dpkg -s inetutils-telnetd 2>/dev/null | awk -F\": \" \"/^Version:/{print \\$2}\")"' >> /start.sh && \
    printf '%s\n' 'echo "[*] Login user: ctf  Password: ctf123456"' >> /start.sh && \
    printf '%s\n' 'echo "[*] Telnet listening on :23"' >> /start.sh && \
    printf '%s\n' 'exec /usr/sbin/inetd -d /etc/inetd.conf' >> /start.sh && \
    chmod +x /start.sh

EXPOSE 23
CMD ["/start.sh"]
